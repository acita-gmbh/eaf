# Epic 3 Retrospective: VM Provisioning

**Date:** 2025-12-12
**Facilitator:** Bob (SM Agent)
**Participants:** Wall-E (Project Lead), Amelia (Dev Agent), Charlie (Senior Dev)
**Epic Duration:** 2025-12-04 to 2025-12-12 (~8 days)
**Stories Completed:** 8 of 9 (89%) | **1 Blocked** (external dependency)

---

## Epic Summary

**Epic Goal:** "VM is actually created" - Transform DCM from a workflow tool into real infrastructure automation.

**Tracer Bullet Status:** DEVELOPMENT COMPLETE

Epic 3 delivered the full VMware integration stack:
- VMware connection configuration with secure credential storage
- VCF SDK 9.0 migration (from deprecated yavijava)
- VcenterAdapter for real vSphere integration
- Automatic provisioning trigger on approval
- CloneVM_Task execution with VMware Tools wait
- Progress tracking with ETA calculation
- Comprehensive error handling with retry and saga compensation
- VM details view with live status refresh
- VM ready email notifications

**Pending:** Story 3-9 (vCenter Contract Test Suite) - BLOCKED awaiting vCenter test infrastructure from IT.

---

## Retrospective Discussion (Party Mode)

---

**Bob (SM):** Welcome everyone to the Epic 3 retrospective. This was our **Critical Risk** epic - the one where we went from mocked infrastructure to real VMware integration. Wall-E, as project lead, how do you feel about what we delivered?

**Wall-E (Project Lead):** This was intense. We touched every layer of the stack - from VCF SDK SOAP bindings to React progress steppers. The risk profile was completely different from Epic 2. We had external dependencies, async operations, and real infrastructure that can fail in unexpected ways.

**Amelia (Dev Agent):** Agreed. The foundation from Epic 1 and Epic 2 really paid off. The CQRS/ES patterns, the hexagonal architecture, the `Result<T,E>` error handling - all of it just worked when we needed to add VMware integration.

**Charlie (Senior Dev):** What surprised me was the VCF SDK migration mid-epic. Story 3.1 started with yavijava, and by Story 3.1.1 we'd pivoted to VCF SDK 9.0. That could have derailed us, but the `VspherePort` abstraction contained the blast radius.

**Bob (SM):** Let's dig into specifics. What went particularly well?

---

### What Went Well

**Amelia (Dev Agent):** Several things stood out:

1. **SDK Migration Smoothness:** The yavijava → VCF SDK 9.0 migration was surgical. Because we had the `VspherePort` interface and `VcsimAdapter` for tests, we could swap the implementation without touching any application code.

2. **Saga Pattern for Complex Flows:** The provisioning saga (`VmRequestApproved` → `ProvisionVmCommand` → `VmProvisioningStarted` → `VspherePort.createVm()` → `VmProvisioned`) cleanly separated concerns. Each step was testable independently.

3. **Progress Callback Pattern:** The `onProgress: suspend (VmProvisioningStage) -> Unit` callback in `VspherePort.createVm()` was elegant. It let infrastructure layer emit progress without knowing about domain events.

4. **Resilience4j Integration:** The retry policy with exponential backoff (10s base, 2x multiplier, 5 total attempts, 120s max) handled transient failures gracefully. VsphereError sealed class with `retriable` flag made it easy to classify errors.

**Charlie (Senior Dev):** The ARM64 skip pattern was a pragmatic solution. Rather than fight QEMU emulation issues, we documented the limitation and ensured CI runs on x86_64. Pragmatism over perfectionism.

**Wall-E (Project Lead):** The BMAD workflow structure continued to help. Each story had clear scope boundaries. Story 3.4 (execution) vs Story 3.6 (error handling) vs Story 3.5 (progress) were distinct concerns that could be developed in sequence.

**Bob (SM):** I noticed Story 3.1.1 was inserted mid-epic. What triggered that?

**Amelia (Dev Agent):** During Story 3.1 implementation, we discovered yavijava's last release was May 2017. Eight years stale, no vSphere 7.x/8.x support, 95+ unresolved issues. That's unacceptable for production infrastructure automation. Story 3.1.1 fixed it before we built more on a shaky foundation.

**Wall-E (Project Lead):** That's actually a positive - we caught a technical debt bomb early and fixed it immediately rather than letting it compound.

---

### What Could Have Gone Better

**Bob (SM):** Every epic has friction points. What were ours?

**Amelia (Dev Agent):**

1. **VCF SDK Port 443 Limitation:** We lost time discovering that `VcenterClientFactory` only works with port 443. Testcontainers use dynamic ports. The workaround (direct JAX-WS binding with `BindingProvider.ENDPOINT_ADDRESS_PROPERTY`) works but isn't pretty.

2. **CXF 4.0 SSL Configuration:** Burned a few hours on TLS handshake failures. CXF 4.0's default `HttpClient` ignores `HTTPConduit` TLS settings. Required `forceURLConnection=true` system property.

3. **Reconstitute Symmetry Bugs:** Multiple times we forgot to add new events to the deserializer or missed `apply()` handlers in aggregates. The pattern is clear but easy to skip a step. We now have it documented as a checklist.

4. **MVP Deferrals:** Guest customization, disk size extension, and network configuration were all MVP-deferred. The core flow works with template defaults, but these are gaps for production use.

**Charlie (Senior Dev):** The ARM64 limitation is real friction for local development. Our whole team is on Apple Silicon. We have to use remote x86_64 Docker hosts or skip VCSIM tests locally.

**Wall-E (Project Lead):** Story 3-9 blocker is frustrating. We have 100% of the code ready, but can't validate against real vCenter because IT hasn't provisioned the test instance. That's an organizational impediment, not a technical one.

---

### Key Technical Decisions

**Bob (SM):** What decisions shaped this epic?

**Amelia (Dev Agent):**

1. **VCF SDK 9.0 from Maven Central (Apache 2.0):** Not the vSphere Automation SDK 8.0.3 from VMware Developer Portal. Simplified CI/CD (no private repo), cleaner licensing, and Maven Central availability.

2. **VsphereSessionManager with ConcurrentHashMap:** Multi-tenant session isolation. Each tenant has their own vCenter session, managed by tenant ID key. Coroutine-based keepalive (15-min interval) prevents session expiry.

3. **Separate VmAggregate and VmRequestAggregate:** The VM lifecycle (provisioning → ready → running) is distinct from the request lifecycle (draft → approved → completed). Two aggregates cleanly separate these concerns.

4. **Fire-and-Forget Notifications:** Email sending uses `CoroutineScope(SupervisorJob())` - notification failures are logged but don't roll back provisioning. User gets their VM even if email service is down.

5. **Timeline as Projection, Not Aggregate State:** Timeline events are read-model projections updated via event handlers. They're not stored in the VmRequest aggregate itself. Clean CQRS separation.

6. **VsphereError Sealed Class ADR-004a Aligned:** Designed `VsphereError` hierarchy to mirror future `HypervisorError` from ADR-004a (multi-hypervisor support). Minimizes refactoring for Epic 6.

**Charlie (Senior Dev):** The `Result<T,E>` pattern was critical. No exceptions cross port boundaries - everything is explicit success/failure types. Makes error handling predictable.

---

### Technical Debt Carried Forward

**Bob (SM):** What technical debt did we consciously accept?

**Amelia (Dev Agent):**

| Debt Item | Reason | Target Resolution |
|-----------|--------|-------------------|
| Guest customization (hostname) | MVP simplicity, template defaults work | Post-MVP enhancement |
| Disk size extension | Template disk size sufficient for MVP | Post-MVP enhancement |
| Network configuration | Using tenant default network | Post-MVP (FR36 partial) |
| ARM64 VCSIM support | Docker image limitation | When VCSIM provides ARM64 image |
| Session pooling | Single connection per request OK for MVP | High-volume optimization |
| vCenter contract tests | Blocked on IT infrastructure | Story 3-9 when unblocked |

**Wall-E (Project Lead):** The Story 3-9 debt is the most significant for production readiness. We're testing against VCSIM, which isn't 100% identical to real vCenter. The contract tests would catch any behavioral differences.

---

### Documentation Updates Made

**Bob (SM):** What got added to project documentation?

**Amelia (Dev Agent):**

- **CLAUDE.md, GEMINI.md, AGENTS.md:**
  - CancellationException handling pattern for coroutines
  - VCF SDK enum convention warning (UPPER_SNAKE_CASE)

- **project-context.md:**
  - VMware VCF SDK 9.0 patterns
  - PropertyCollector usage
  - Port 443 workaround documentation
  - New domain event checklist (5 steps)

- **Story files:** All 10 stories have complete Dev Agent Records with file lists and implementation notes

- **Architecture.md:** VmAggregate and VmRequestAggregate interaction documented

---

### Preview: Epic 4 (Projects & Quota)

**Bob (SM):** Let's look ahead. Epic 4 is marked **Medium Risk**. What should we be aware of?

**Wall-E (Project Lead):** Epic 4 shifts focus from infrastructure to organization. We're building:
- Project aggregate for grouping VMs
- Tenant-level quota configuration
- Quota enforcement on VM requests
- Resource utilization dashboard

The risk profile is lower because it's mostly CRUD + business rules. No external system integration like VMware.

**Charlie (Senior Dev):** Key stories to watch:
- **Story 4.1 (Project Aggregate):** Foundation for all project features
- **Story 4.7 (Tenant Quota Configuration):** New aggregate pattern
- **Story 4.8 (Quota Enforcement):** Synchronous invariant checking

**Amelia (Dev Agent):** What from Epic 3 will help us in Epic 4?
- Event sourcing patterns proven and stable
- Frontend component library mature (cards, badges, forms)
- CQRS query patterns established
- The test infrastructure is solid

**Bob (SM):** Any concerns?

**Charlie (Senior Dev):** Quota enforcement needs careful attention. Race conditions are possible when multiple users submit requests simultaneously. Optimistic locking patterns from Epic 2 apply here.

---

### Action Items

| Action | Owner | Priority |
|--------|-------|----------|
| Track vCenter test infrastructure provisioning with IT | PM (John) | High |
| Complete Story 3-9 when vCenter available | Dev | High - Blocked |
| Document ARM64 VCSIM workarounds in CONTRIBUTING.md | Dev | Medium |
| Add domain event checklist to story template | SM | Low |
| Review MVP-deferred items for post-MVP prioritization | PM | Medium |
| Update sprint-status.yaml with Epic 3 retrospective status | SM | Immediate |

---

## Metrics Summary

| Metric | Value |
|--------|-------|
| Stories Planned | 9 (+2 inserted: 3.1.1, 3.1.2) |
| Stories Completed | 8 |
| Stories Blocked | 1 (3-9, external dependency) |
| Mid-Epic Insertions | 2 (VCF SDK migration stories) |
| Backend Unit Tests | 200+ |
| Frontend Unit Tests | 420+ |
| E2E Tests | 50+ |
| PRs Merged | 10 (one per story, some combined) |
| Duration | ~8 days |
| New Database Migrations | V008 - V012 |

---

## Final Thoughts

**Bob (SM):** Any closing thoughts?

**Wall-E (Project Lead):** Epic 3 was the make-or-break epic. We now have real VMware integration - VMs actually get created. The foundation is solid: SDK migration, error handling, retry logic, progress tracking, notifications. Story 3-9 is the validation gate, but the code is production-ready.

**Amelia (Dev Agent):** The velocity was impressive - 8 stories in 8 days including a mid-epic SDK migration. The architecture held up beautifully under the stress of real infrastructure integration. The patterns we established in Epic 1 and 2 paid dividends.

**Charlie (Senior Dev):** The saga pattern for provisioning is elegant. When something fails, compensation kicks in automatically. When it succeeds, all the right events flow through. It's exactly what event-driven architecture should look like.

**Bob (SM):** Epic 3 retrospective complete. **Excellent work, team.** The "Critical Risk" epic is behind us.

---

_Retrospective facilitated by BMAD Method v6 retrospective workflow_
_Generated: 2025-12-12_
