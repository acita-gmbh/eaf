# Epic 2 Retrospective: Core Workflow

**Date:** 2025-12-04
**Facilitator:** Bob (SM Agent)
**Participants:** Wall-E (Project Lead), Amelia (Dev Agent)
**Epic Duration:** 2025-11-28 to 2025-12-04 (~7 days)
**Stories Completed:** 13 (including 2-9a added mid-epic)

---

## Epic Summary

**Epic Goal:** "Request -> Approve -> Notify" - Users can request VMs, admins approve, everyone gets notified.

**Tracer Bullet Status:** COMPLETE

Epic 2 delivered the full core workflow:
- Keycloak authentication integration
- End-user dashboard with empty states and onboarding
- VM request form with validation and submission
- Request list, detail view, and status timeline
- Admin approval queue with filtering
- Approve/reject actions with optimistic locking
- Email notifications with async fire-and-forget pattern

---

## Retrospective Discussion (Party Mode)

---

**Bob (SM):** Welcome everyone to the Epic 2 retrospective. This was our first "tracer bullet" epic - the one that proves the full stack works end-to-end. Wall-E, as project lead, how do you feel about what we delivered?

**Wall-E (Project Lead):** Honestly, really pleased. We went from "foundation only" to a fully working approval workflow in about a week. The CQRS/ES architecture from Epic 1 paid off - adding new commands like approve/reject was straightforward because the patterns were already established.

**Amelia (Dev Agent):** Agreed. Story 2.6 (Submit Command) was the critical integration point. Once that full-stack path worked - React form to Spring controller to aggregate to event store to projection - everything else built on top of it naturally.

**Bob (SM):** Let's dig into specifics. What went particularly well?

---

### What Went Well

**Amelia (Dev Agent):** Several things stood out:

1. **Pattern Reuse:** The `CancelVmRequestHandler` became the template for `ApproveVmRequestHandler` and `RejectVmRequestHandler`. Same for frontend mutation hooks. Copy-adapt-test.

2. **Component Library:** EmptyState, StatusBadge, OnboardingTooltip - these became building blocks. By Story 2.9, we were assembling pages from existing components rather than building from scratch.

3. **Code Review Process:** Catching issues before merge saved significant rework. The click-outside dismiss issue in Story 2.3 would have been a bug report from users otherwise.

**Wall-E (Project Lead):** The BMAD workflow structure really helped. Having explicit acceptance criteria meant we knew when we were done. No scope creep because the story defined the boundaries.

**Bob (SM):** I noticed Story 2-9a was added mid-epic via correct-course workflow. What happened there?

**Amelia (Dev Agent):** Good catch. During Story 2.9 code review, we realized our E2E tests weren't properly authenticating via Keycloak. They were testing the UI, but not the full auth flow. Story 2-9a fixed that gap - added `auth.setup.ts` with `storageState` pattern and Keycloak JWT role mapping integration tests.

**Wall-E (Project Lead):** That's actually a positive - the process caught a gap and we fixed it systematically rather than letting it become tech debt.

---

### What Could Have Gone Better

**Bob (SM):** Every epic has friction points. What were ours?

**Amelia (Dev Agent):**

1. **E2E Auth Setup Too Late:** We should have added the Playwright auth setup in Story 2.1 (Keycloak Login Flow), not Story 2.9. We had 8 stories of E2E tests that weren't fully integrated with real auth.

2. **MockK Default Parameter Gotcha:** Lost about 30 minutes debugging a test failure because `coEvery { handler.handle(any()) }` with a defaulted `correlationId` parameter created an unexpected `eq()` matcher. Now documented in project-context.md, but it bit us.

3. **Project Name Resolution:** Email notifications show project UUID instead of human-readable name. We punted on this as "MVP tradeoff" but it's visible to users. Should have had a simple lookup.

**Wall-E (Project Lead):** The timeline was aggressive. 13 stories in ~7 days. That's nearly 2 stories per day. We made some tradeoffs:
- E2E tests scaffolded but marked `skip` pending full integration
- Some integration tests rely on mocked responses rather than real Keycloak
- Technical debt documented but not addressed (GDPR crypto-shredding)

**Bob (SM):** Were any stories harder than expected?

**Amelia (Dev Agent):** Story 2.12 (Email Notifications) had complexity in the event structure. We needed to add `requesterEmail` to domain events for the notification listener. That meant updating VmRequestCreated, VmRequestApproved, and VmRequestRejected events. Not hard, but required coordination across layers.

Story 2.8 (Request Status Timeline) was also more complex than it looked. The timeline projection pattern - deterministic IDs, ON CONFLICT DO NOTHING, actor name resolution - required careful design to avoid duplicates and race conditions.

---

### Key Technical Decisions

**Bob (SM):** What decisions shaped this epic?

**Amelia (Dev Agent):**

1. **Fire-and-Forget Email Pattern:** Email notifications use `CoroutineScope(SupervisorJob())` to not block the command handler. If email fails, it's logged but doesn't roll back the transaction. Simple, resilient, appropriate for MVP.

2. **Denormalized Events:** Adding `requesterEmail`, `vmName`, `projectId` to events means the notification listener doesn't need to query aggregates. Trades storage for simplicity.

3. **Forbidden â†’ 404 for Security:** All resource access errors return 404 to prevent tenant enumeration attacks. This pattern is now enforced project-wide.

4. **React Compiler Compatibility:** No `useMemo`/`useCallback` - let the compiler optimize. Used `useWatch` instead of `watch()` for React Hook Form fields.

**Wall-E (Project Lead):** The `@EnableReactiveMethodSecurity` annotation was a key unlock. Without it, `@PreAuthorize("hasRole('ADMIN')")` was silently ignored. That's now in SecurityConfig and tested.

---

### Technical Debt Carried Forward

**Bob (SM):** What technical debt did we consciously accept?

**Amelia (Dev Agent):**

| Debt Item | Reason | Target Resolution |
|-----------|--------|-------------------|
| Email addresses in events (plain text) | MVP simplicity | Epic 5 (GDPR crypto-shredding) |
| Project name shows UUID | No ProjectDirectory interface | Epic 4 (Projects & Quota) |
| Some E2E tests marked skip | Auth integration incomplete | Early Epic 3 |
| Manual SMTP config | No per-tenant config UI | Growth phase |
| Polling interval hardcoded | Not configurable | Growth phase |

**Wall-E (Project Lead):** The GDPR debt is the most significant. Email addresses are PII, and we're storing them in the event store without encryption. Epic 5 has crypto-shredding planned, but that's a while out.

---

### Documentation Updates Made

**Bob (SM):** What got added to project documentation?

**Amelia (Dev Agent):**

- **project-context.md:** Added MockK default parameter gotcha, `void` operator for floating promises, TanStack Query polling patterns
- **CLAUDE.md:** Updated with `vi.hoisted()` pattern for Vitest, `useWatch` vs `watch()` guidance, read-only props requirement
- **Story files:** All 13 stories have complete Dev Agent Records with file lists and implementation notes

---

### Preview: Epic 3 (VM Provisioning)

**Bob (SM):** Let's look ahead. Epic 3 is marked **Critical Risk**. What should we be aware of?

**Wall-E (Project Lead):** Epic 3 is where we go from "workflow tool" to "infrastructure automation". We're integrating with real VMware vSphere APIs. The risk profile is completely different:

- **External dependency:** vSphere API can fail, timeout, return partial results
- **Idempotency critical:** Can't accidentally create two VMs for one request
- **Async operations:** Provisioning takes minutes, not milliseconds
- **Resource cleanup:** Failed provisions need cleanup

**Amelia (Dev Agent):** Story 1.10 (VCSIM Integration) was done in Epic 1 specifically for this. We have a vCenter simulator for testing. But real vCenter might behave differently.

Key stories to watch:
- **Story 3.4 (VM Provisioning Execution):** The core integration with vSphere API
- **Story 3.6 (Provisioning Error Handling):** Circuit breaker, retry logic
- **Story 3.9 (vCenter Contract Test Suite):** Marked BLOCKED awaiting real vCenter access

**Bob (SM):** What from Epic 2 will help us in Epic 3?

**Amelia (Dev Agent):**
- Event sourcing patterns are proven - adding `VmProvisioned`, `ProvisioningFailed` events will follow the same patterns
- Timeline projection works - provisioning progress can use the same mechanism
- Email notifications work - "VM Ready" notification is just another template
- The frontend patterns (TanStack Query, toast notifications, status updates) all transfer directly

---

### Action Items

| Action | Owner | Priority |
|--------|-------|----------|
| Enable remaining E2E tests with full auth | Dev | High |
| Add ProjectDirectory interface for name resolution | Dev | Medium |
| Update CLAUDE.md with vi.hoisted() testing pattern | SM | Low |
| Create Epic 3 tech context before starting | SM | High |
| Review VCSIM integration test coverage | Dev | Medium |

---

## Metrics Summary

| Metric | Value |
|--------|-------|
| Stories Planned | 12 |
| Stories Completed | 13 (including 2-9a) |
| Mid-Epic Adjustments | 1 (Story 2-9a via correct-course) |
| Code Review Issues Found | ~15 (all resolved before merge) |
| Backend Unit Tests | 150+ |
| Frontend Unit Tests | 380+ |
| E2E Tests | 40+ (some pending full integration) |
| PRs Merged | 13 (one per story) |
| Duration | ~7 days |

---

## Final Thoughts

**Bob (SM):** Any closing thoughts?

**Wall-E (Project Lead):** Epic 2 validated our architecture. CQRS/ES + React + PostgreSQL RLS is working as designed. The "tracer bullet" hit the target. Epic 3 will stress-test the async/failure handling, but the foundation is solid.

**Amelia (Dev Agent):** The pace was fast but sustainable. Having clear patterns meant less decision fatigue per story. The code review process caught real issues. The BMAD workflow kept us focused. Ready for Epic 3.

**Bob (SM):** Epic 2 retrospective complete. Marking `epic-2-retrospective: completed` in sprint-status.yaml. Great work, team.

---

_Retrospective facilitated by BMAD Method v6 retrospective workflow_
_Generated: 2025-12-04_
