<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:flowable="http://flowable.org/bpmn"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
             targetNamespace="http://www.axians.com/eaf/ansible">

  <!--
    Story 6.4 (Task 6): Example BPMN Process with Ansible Service Task

    Demonstrates RunAnsiblePlaybookTask delegate usage with:
    - Service task configured with flowable:delegateExpression (Subtask 6.2)
    - Required process variables documented (Subtask 6.3)
    - Error boundary event for failure handling (Subtask 6.4, Story 6.5 prerequisite)

    Required Process Variables:
    - tenantId: String (MANDATORY for multi-tenant isolation)
    - playbookPath: String (MANDATORY - path to Ansible playbook, e.g., "hello-world.yml")
    - inventory: String (optional - Ansible inventory file path)
    - extraVars: Map<String, Any> (optional - variables passed to playbook)

    Output Variables (set by RunAnsiblePlaybookTask):
    - ansibleExitCode: Int (playbook exit code)
    - ansibleStdout: String (standard output from playbook)
    - ansibleStderr: String (standard error from playbook)
  -->

  <process id="hello-world-ansible" name="Hello World Ansible Process" isExecutable="true">

    <!-- Start Event -->
    <startEvent id="start" name="Start" />

    <!-- Service Task: Execute Ansible Playbook -->
    <serviceTask id="ansibleTask"
                 name="Run Ansible Playbook"
                 flowable:delegateExpression="${runAnsiblePlaybookTask}">
      <documentation>
        Executes Ansible playbook via SSH using RunAnsiblePlaybookTask delegate.

        Required Variables (from process start):
        - tenantId: Tenant identifier for isolation
        - playbookPath: Path to Ansible playbook (e.g., "hello-world.yml")
        - inventory: (optional) Ansible inventory file
        - extraVars: (optional) Map of variables for playbook

        Output Variables (set by task):
        - ansibleExitCode: Playbook exit code
        - ansibleStdout: Standard output
        - ansibleStderr: Standard error
      </documentation>
    </serviceTask>

    <!-- Error Boundary Event: Catches Ansible Failures -->
    <boundaryEvent id="ansibleError"
                   name="Ansible Failed"
                   attachedToRef="ansibleTask">
      <errorEventDefinition errorRef="ansibleFailed" />
    </boundaryEvent>

    <!-- Success Path: End Event -->
    <endEvent id="endSuccess" name="Playbook Succeeded" />

    <!-- Failure Path: End Event -->
    <endEvent id="endFailure" name="Playbook Failed" />

    <!-- Sequence Flows -->
    <sequenceFlow id="flow1" sourceRef="start" targetRef="ansibleTask" />
    <sequenceFlow id="flow2" sourceRef="ansibleTask" targetRef="endSuccess" />
    <sequenceFlow id="flow3" sourceRef="ansibleError" targetRef="endFailure" />

  </process>

  <!-- Error Definition for Ansible Failures -->
  <error id="ansibleFailed" errorCode="ANSIBLE_FAILED" />

</definitions>
