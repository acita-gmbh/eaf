# DVMM Product - Full Stack E2E Environment
#
# Usage:
#   # Start everything (full E2E environment)
#   docker compose -f docker/dvmm/docker-compose.yml up -d --wait
#
#   # Start only infrastructure (for local backend development)
#   docker compose -f docker/dvmm/docker-compose.yml --profile dev up -d --wait
#
#   # Run E2E tests
#   cd dvmm/dvmm-web && npm run test:e2e
#
#   # Stop everything
#   docker compose -f docker/dvmm/docker-compose.yml down

include:
  - path: ../eaf/docker-compose.yml

services:
  backend:
    build:
      context: ../..
      dockerfile: docker/dvmm/Dockerfile.backend
    container_name: dvmm-backend
    profiles: ["", "default"]  # Exclude from 'dev' profile
    environment:
      SPRING_PROFILES_ACTIVE: local
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/eaf_test
      SPRING_DATASOURCE_USERNAME: eaf
      SPRING_DATASOURCE_PASSWORD: eaf
      KEYCLOAK_ISSUER_URI: http://keycloak:8080/realms/dvmm
      KEYCLOAK_JWK_SET_URI: http://keycloak:8080/realms/dvmm/protocol/openid-connect/certs
      CORS_ALLOWED_ORIGINS: http://localhost:5173,http://127.0.0.1:5173
      # Use a fixed encryption key for E2E testing (not for production!)
      ENCRYPTION_SECRET_KEY: e2e-test-key-32-chars-exactly!!
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - eaf-network

  frontend:
    image: node:22-alpine
    container_name: dvmm-frontend
    profiles: ["", "default"]  # Exclude from 'dev' profile
    working_dir: /app
    # Skip playwright-utils git submodule (not needed for dev server)
    command: sh -c "npm ci --ignore-scripts && npm run dev -- --host 0.0.0.0"
    environment:
      VITE_KEYCLOAK_URL: http://localhost:8180
      VITE_KEYCLOAK_REALM: dvmm
      VITE_KEYCLOAK_CLIENT_ID: dvmm-web
      VITE_API_URL: http://localhost:8080
    ports:
      - "5173:5173"
    volumes:
      - ../../dvmm/dvmm-web:/app
      - dvmm-frontend-node-modules:/app/node_modules
    depends_on:
      - backend
    networks:
      - eaf-network

volumes:
  dvmm-frontend-node-modules:
    name: dvmm-frontend-node-modules
